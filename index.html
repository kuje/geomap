<!-- css will be leaked through inside shadow dom -->
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>

<script src="http://d3js.org/d3.v3.min.js"></script>


<style>
  html, body {
  	margin: 0;
  	height: 100%;
  }

  geomap {
    display: block;
    height: 100%;
    width: 100%;
  }

  button {
  	z-index: 1;
  	position: absolute;
  	top: 1em;
  	right: 1em;
  }

  smurffi {
    fill: "red";
    kakka: "green";
  }
</style>

<template id="geomapDivTemplate">
  <style>
    /* this causes glitches; instead, we leak leaflet css from the host */
    /*@import url("http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css");*/
    div.geomap {
      width: 100%;
      height: 100%;
    }
  </style>
  <div class="geomap"></div>
</template>

<button onclick="javascript:smurffitulee(this)">smurffi</button>

<geomap lat="60.2497278" lon="24.0649247" zoomlevel="14">
	<smurffi lat="60.25" lon="24.0" fill="black">ESIDOM</smurffi>
	<smurffi lat="60.255" lon="24.0" fill="black">ESIDOM</smurffi>

</geomap>

<script src="html5geomap.js"></script>
<script src="html5geomap.domobserver.js"></script>

<script>

var geomap = document.querySelector("geomap")
var maplatlng = [ parseFloat(geomap.getAttribute("lat")), parseFloat(geomap.getAttribute("lon")) ]

globaalidata = [
  {
    latlng: [ maplatlng[0]+0.001, maplatlng[1] ]
  },
  {
    latlng: [ maplatlng[0]+0.003, maplatlng[1] ]
  },
  {
    latlng: [ maplatlng[0]+0.002, maplatlng[1] ]
  }
];

geomap.addEventListener("click", function(e) {
  console.log("geomap click", e)
});


smurffitulee = function(el) {
	var s = document.createElement("smurffi")
	s.setAttribute("lat", 60.2497278)
	s.setAttribute("lon", 24.1)
	s.setAttribute("fill", "blue")
	s.textContent = "MOI UUS SMURFFI"

	// LEAFLET KAAPPAA
	s.addEventListener("click", function(e) {
		console.log("smurfi click", e)
	})

	document.querySelector("geomap").appendChild(s)
}

smurrffiliikkuu = function() {
  globaalidata[0].latlng[0] += 0.001;

  paivitaSmurffit(globaalidata);
}

paivitaSmurffit = function(data) {

  d3map = d3.select("geomap")
  console.log("d3map", d3map)

  var smurffit = d3map.selectAll("smurffi")
  .data(data)

  smurffit
  .enter()
  .append("smurffi")
  // .each(angular.element(document.querySelector("map")).scope().compileri);

  smurffit
  .text(function(d, i){return i;})
  .attr("lat", function(d) {
    return d.latlng[0];
  })
  .attr("lon", function(d) {
     return d.latlng[1];
   })
  // .each(angular.element(document.querySelector("map")).scope().updateri);

}


window.addEventListener("DOMContentLoaded", function() {

  // paivitaSmurffit(globaalidata);

});

</script>